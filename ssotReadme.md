# SSOT(Single Source Of Truth) layer Stored Procedure Documentation

## Overview
This document provides details about the stored procedures, including their purpose, usage, and execution process.

## General Purpose of the Layer
This layer is responsible for transforming core data into SSOT layer

## Script Scheduling
This section outlines the execution order of the sql scripts

| Order | Script Name                                                | Purpose                                                                                         |
|-------|------------------------------------------------------------|-------------------------------------------------------------------------------------------------|
| 1     |     sp_bridge_01_revenue                                     | This stored procedure consolidates and organizes revenue data by customer, product, and region, focusing on tracking recurring revenue. It generates a unique revenue key by combining various dimension fields to ensure accurate and structured data analysis.                                                                                              |
| 2     |           sp_bridge_02_customer                           | The stored procedure retrieves relevant fields from the silver_ssot.revenue table, creates unique combinations of customer details.     |
| 3     | sp_bridge_03_customer_contract                  |  This Stored Procedure calculates the join month, end month, and churn month for each customer based on their revenue records                                                                                        |
| 4     | sp_bridge_04_product     | The stored procedure retrieves relevant fields from the silver_ssot.revenue table, creates unique combinations of product details.                                                                                              |
| 5     | sp_bridge_05_customer_product_contract                                       | This stored procedure calculates the start, end, and anticipated churn months for each customer-product pair based on recurring revenue data and product details.                                           |
| 6     | sp_bridge_06_other                                         | The stored procedure retrieves relevant fields from the silver_ssot.revenue table, creates unique combinations of other details.                                                                                             |
| 7     | sp_bridge_07_calendar                              |  This Script generates a series of month values based on the date range from the revenue table. It calculates the range from the earliest date in the revenue table and extends it by 12 months, filling the calendar with monthly intervals.                                                                                          |
| 8     | sp_bridge_08_monthly_revenue                       | This stored procedure processes revenue data by joining it with customer contract information to calculate and aggregate ARR (Annual Recurring Revenue) across different months.                                                                                              |
| 9     | sp_bridge_09_customer_lifecycle_events                             | This stored procedure calculates lifecycle flags for customers based on their join and churn months, producing monthly, quarterly, yearly, and year-to-date indicators for new, churned, and existing customers.                                                                                              |
| 10    | sp_bridge_10_customer_product_lifecycle_events                                  | This stored procedure calculates product lifecycle flags by evaluating churn and existing status across different periods (monthly, quarterly, yearly, and year-to-date), based on revenue and customer lifecycle data.                                                                                             |
| 11    | sp_bridge_11_period_revenue                                  | This stored procedure calculates ARR changes over different periods (monthly, quarterly, yearly, and year-to-date) and provides insights into how revenue evolves over time.                                                                                            |
| 12    |sp_bridge_12_customer_product_revenue_events                                  | This stored procedure calculates flags for revenue events by assessing product growth and decline across various periods (monthly, quarterly, yearly, and year-to-date), joining revenue data with customer and product lifecycle information to identify cross-sell, upsell, and downsell activities.                                                                                             |
| 13    | sp_bridge_13_delta_revenue                                  |This stored procedure calculates revenue deltas by applying flags for changes like acquisition, churn, cross-sell, upsell, and downsell over various time periods(monthly, quarterly, last 12 months, and year-to-date), using joins between revenue data and customer and product lifecycle tables.                                                                                             |
| 14    | sp_bridge_main                                  | This script is a main stored procedure that run procedures from all layers.                                                                                            |
| 15    | sp_bridge_test                               | The check, where All metrics reconcile accurately and arr bridge balances                                                                                             |

## Script Details
This section outlines the details about the SQL scripts required to generate the final outputs.
| Order | Source             | Target                            | Summarisation Logic                                                                                                                                                                                                                                                                                                                                                                              | Filters Applied                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|-------|--------------------|------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1     | core_customer_cube | revenue                            | • Type Casting <br>  • Calculate Revenue, ARR, MRR, Volume <br> • Generating Primary Keys using MD5() <br> • Truncates the date                                                                                                                                                                                                                                                                 | • month >= '2021-01-01' AND product_suite != 'CivicHR' <br> • revenue IS NOT NULL  AND revenue <> 0.00                                                                                                                                                                                                                                                                                                                                                          |
| 2     | revenue            | customer                           | -                                                                                                                                                                                                                                                                                                                                                                                                | -                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 3     | revenue            | customer_contract                  | •Calculate customer_join_month, customer_end_month, customer_churn_month  <br> • Calculate parent_customer_join_month, parent_customer_end_month, parent_customer_churn_month                                                                                                                                                                                                                   | •(revenue_type = 'Recurring' or revenue_type = 1 ) AND revenue <> 0.00                                                                                                                                                                                                                                                                                                                                                   |
| 4     | revenue            | product                            | -                                                                                                                                                                                                                                                                                                                                                                                                | -                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 5     | revenue            | customer_product_contract          | •Calculate product_sub_type_start_month, product_sub_type_end_month, product_sub_type_churn_month  <br> •Calculate product_suite_start_month, product_suite_end_month, product_suite_churn_month <br> • Join with product_sub_type, product_suite tables to get customer_product_contract table                                                                                                   | • revenue_type = 'Recurring' OR revenue_type = 1                                                                                                                                                                                                                                                                                                                                                                       |
| 6     | revenue            | other                              | -                                                                                                                                                                                                                                                                                                                                                                                                | -                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 7     | revenue            | calendar                           | •Calculate the start and end dates <br> • Calculate the number of months between start_date and end_date                                                                                                                                                                                                                                                                                        | -                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 8     | revenue            | monthly_revenue                    | • Calcualte ARR, MRR, Revenue, Volume, Ytd_helper <br> • Filling in the gaps for each customer with 0 revenue whenever a reacord of revenue for a customer on a month is not available  <br> • Join with customer_contract, calendar to get monthly_revenue                                                                                                                                     | • revenue <> 0.00                                                                                                                                                                                                                                                                                                                                                                                                         |
| 9     | monthly_revenue    | customer_lifecycle_events          | • Calculate customer_join_month_difference, customer_churn_month_difference, parent_customer_join_month_difference, parent_customer_churn_month_difference <br> • Join with customer_contract                                                                                                                                                                                                  | -                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 10    | monthly_revenue    | customer_product_lifecycle_events  | • Calculate product_suite_start_month_difference, product_suite_churn_month_difference, product_sub_type_start_month_difference, product_sub_type_churn_month_difference, product_module_start_month_difference, product_module_churn_month_difference <br> • Join with customer_product_contract                                                      | -                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 11    | monthly_revenue    | period_revenue                     | • Calculate revenue lags based on the above declared variables for monthly, yearly, and quarterly <br> • Calculate sum_arr_lm_delta, sum_arr_l3m_delta, sum_arr_ltm_delta, sum_arr_ytd_delta                                                                                                                                                                                                   | -                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 12    | period_revenue     | customer_product_revenue_events    | • Join with customer_lifecycle_events, customer_product_lifecycle_events, customer_product_contract to get customer_product_revenue_events                                                                                                                                                                                                                                                      | -                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 13    | period_revenue     | delta_revenue                      | • Calculate ltm_delta,lm_delta, ytm_delta, l3m_delta for each parent_customer_new,customer_new, parent_customer_churn, customer_churn, product_suite_cross_sell, product_suite_churn, product_sub_type_cross_sell, product_sub_type_churn, product_module_cross_sell, product_module_churn, upsell, downsell <br>• Join with customer_lifecycle_events, customer_product_lifecycle_events, customer_product_contract to get customer_product_revenue_events | -                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 14    | core_*             | ssot_*                             | -                                                                                                                                                                                                                                                                                                                                                                                     | -                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 15    | fact_arr_bridge    | 1.waterfall_balance_check <br> 2.arr_continuous_check <br> 3.arr_monthly_rate_check <br> 4.arr_movements_signs_check | • Calculate net_bop, net_downsell, net_upsell, net_product_module_cross_sell, net_product_sub_type_cross_sell, net_product_suite_cross_sell, net_nrr, net_new_customer, net_new_parent_customer, net_customer_churn, net_parent_customer_churn, net_product_module_churn, net_product_sub_type_churn, net_product_suite_churn, net_eop  •  Join with dim_customer, dim_product <br> • RAISE NOTICE  <br> • Calculate ARR Continuous Check, Waterfall Balance Check, ARR Movements Sign Check, ARR Movements Sign Check | • abs(net_bop + net_parent_customer_churn + net_customer_churn + net_product_suite_churn + net_product_sub_type_churn + net_product_module_churn + net_downsell + net_upsell + net_product_module_cross_sell + net_product_sub_type_cross_sell + net_product_suite_cross_sell + net_new_customer + net_new_parent_customer - net_eop) > 0.0001 <br>  •  BoP <> EoP  |


