# Gold Layer Stored Procedure Documentation

## Overview
This document provides details about the stored procedures, including their purpose, usage, and execution process.

## General Purpose of the Layer
This layer is responsible for transforming SSOT data into the Gold layer. These procedures and tables work together to generate data for various KPIs such as revenue calculations, customer lifecycle management, and product performance. They ensure the accuracy and consistency of the data used in reporting and analysis.

## Script Scheduling
This section outlines the execution order of the SQL scripts.

| Order | Script Name                              | Purpose                                                                                                         |
|-------|------------------------------------------|-----------------------------------------------------------------------------------------------------------------|
| 1     | sp_dim_calendar                          | Creates a dimension calendar table that maintains calendar-related data to support time-based analysis.       |
| 2     | sp_dim_customer                          | Populates dimension data related to customers.                                                                 |
| 3     | sp_dim_other                             | Creates a table to store miscellaneous dimension data.                                                         |
| 4     | sp_dim_product                           | Populates a dimension table with product-related data.                                                         |
| 5     | sp_fact_arr_bridge                       | Creates the ARR bridge fact table.                                                                             |
| 6     | sp_fact_arr_bridge_parent_product_suite  | Creates a fact table for parent product suite ARR bridge calculations.                                         |
| 7     | sp_fact_arr_bridge_parent                | Creates a fact table for parent ARR bridge calculations.                                                       |
| 8     | sp_fact_cross_holding                    | Creates a fact table that stores data related to cross-holdings.                                               |

## Script Details
This document outlines the data transformation steps for various sources and targets, detailing the summarization logic and filters applied.

| **OrderID** | **Source**                         | **Target**                           | **Summarisation Logic**                                                                                                                                           | **Filters Applied**                                                                                                 |
|-------------|------------------------------------|--------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------|
| 1           | calendar                           | dim_calendar                        | • **Add Derived Columns:**<br>- year = Extract year from month_roll<br>- month_no = Extract month number from month_roll<br>- month_name = Full month name from month_roll<br>- quarter = Q + quarter number from month_roll<br>- qq_yyyy = Q + quarter + year in two-digit format (e.g., Q1'25)<br>- mmm_yy = Month and year (e.g., Apr-25) | -                                                                                                                    |
| 2           | customer                           | dim_customer                        | 1. **Join** customer with customer_contract on customer_id to get customer dimension table<br>2. **Add Derived Columns:**<br>• customer_cohort_month = customer_join_month from customer_contract<br>• customer_cohort_year = Year extracted from customer_join_month<br>• parent_customer_cohort_month = parent_customer_join_month from customer_contract<br>• parent_customer_cohort_year = Year extracted from parent_customer_join_month | -                                                                                                                    |
| 3           | other                              | dim_other                           | -                                                                                                                                                                 | -                                                                                                                    |
| 4           | product                            | dim_product                         | -                                                                                                                                                                 | -                                                                                                                    |
| 5           | delta_revenue<br>monthly_revenue<br>period_revenue<br>customer_contract | fact_arr_bridge                     | 1. **Join** delta_revenue with monthly_revenue and period_revenue using delta_revenue_key<br>2. **Assign period_type** as 'lm', 'l3m', 'ltm', 'ytd'<br>3. Combines all types of period revenues into one, enabling slicing and dicing between the period types in BI.<br>4. **Join** with customer_contract for customer tenure details<br>5. **Calculate GRR and NRR** | -                                                                                                                    |
| 6           | fact_arr_bridge<br>dim_customer<br>dim_product | fact_arr_bridge_parent_product_suite | 1. **Join** dim_customer to get customer_key and parent_customer_id<br>2. **Join** dim_product to get product_key and product_suite<br>3. **Calculate and summarize key metrics** like: bop_arr, parent_customer_churn, product_suite_churn, downsell, upsell, etc.<br>4. **Aggregate by** month_roll, period_type, parent_customer_id, and product_suite<br>5. **Calculate grr and nrr** using summarized metrics. | -                                                                                                                    |
| 7           | fact_arr_bridge_parent_product_suite | fact_arr_bridge_parent              | 1. **Calculate and summarize key metrics** by month_roll, period_type, and parent_customer_id:<br>- bop_arr, parent_customer_churn, downsells, upsells, new_parent_customer, eop_arr<br>2. **Use conditional logic** for downsells and upsells:<br>- If the sum of churn and cross-sells is negative, assign to downsells.<br>- If the sum is positive, assign to upsells<br>3. **Calculate**:<br> 1. grr -> as bop_arr + parent_customer_churn + downsell<br> 2. Nrr -> bop_arr + parent_customer_churn + downsell + upsell | -                                                                                                                    |
| 8           | revenue<br>dim_product             | fact_cross_holding                  | 1. **Join** the revenue table with dim_product to fetch product_level_1 and product_suite information.<br>2. **Derive columns:** cross_holding_key, customer_key, month, product_key, product_level_1, and product_suite | r1.arr <> 0 AND (r1.revenue_type = '1' OR r1.revenue_type = 'Recurring') on base table |

